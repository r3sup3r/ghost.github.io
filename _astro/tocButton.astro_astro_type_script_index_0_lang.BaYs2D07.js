import{N as g}from"./constants.Cd1PiS3e.js";import{w as u}from"./widget.BaHW3_Oe.js";import"./config.BFBf_zv3.js";class f extends HTMLElement{tocEl=null;visibleClass="visible";observer;anchorNavTarget=null;headingIdxMap=new Map;headings=[];tocEntries=[];active=[];activeIndicator=null;_retryCount=0;_backToTopObserver=null;_handleBtnClick=e=>{e.stopPropagation();const t=this.querySelector(".toc-floating-panel"),i=t?.classList.contains("hidden")||t?.classList.contains("opacity-0");this.toggleFloatingPanel(!!i)};_handleDocClick=e=>{const t=this.querySelector(".toc-floating-panel");t&&!t.classList.contains("hidden")&&!t.contains(e.target)&&this.toggleFloatingPanel(!1)};constructor(){super(),this.observer=new IntersectionObserver(this.markVisibleSection)}markActiveHeading=e=>{this.active=new Array(this.headings.length).fill(!1),this.active[e]=!0};isInRange(e,t,i){return t<e&&e<i}fallback=()=>{if(!this.headings.length)return;let e=-1;for(let t=0;t<this.headings.length&&this.headings[t].getBoundingClientRect().top<100;t++)e=t;e===-1&&(e=0),this.markActiveHeading(e)};toggleActiveHeading=()=>{let e=this.active.length,t=-1;for(let i=0;i<this.active.length;i++)this.active[i]?(this.tocEntries[i].classList.add(this.visibleClass),e=Math.min(e,i),t=Math.max(t,i)):this.tocEntries[i].classList.remove(this.visibleClass);if(t===-1)this.activeIndicator?.setAttribute("style","opacity: 0");else{const i=this.tocEntries[e].offsetTop,n=this.tocEntries[t].offsetTop+this.tocEntries[t].offsetHeight;this.activeIndicator?.setAttribute("style",`top: ${i}px; height: ${n-i}px; opacity: 1`)}};scrollToActiveHeading=()=>{if(this.anchorNavTarget||!this.tocEl)return;const e=this.querySelectorAll(`.${this.visibleClass}`);if(!e.length)return;const t=e[0],i=e[e.length-1],n=this.tocEl.clientHeight;let s;i.getBoundingClientRect().bottom-t.getBoundingClientRect().top<.9*n?s=t.offsetTop-32:s=i.offsetTop-n*.8,this.tocEl.scrollTo({top:s,left:0,behavior:"smooth"})};update=()=>{requestAnimationFrame(()=>{this.toggleActiveHeading(),this.scrollToActiveHeading()})};markVisibleSection=e=>{e.forEach(t=>{const i=t.target.getAttribute("id"),n=i?this.headingIdxMap.get(i):void 0;n!=null&&(this.active[n]=t.isIntersecting),t.isIntersecting&&this.anchorNavTarget==t.target&&(this.anchorNavTarget=null)}),this.active.includes(!0)||this.fallback(),this.update()};handleAnchorClick=e=>{const t=e.composedPath().find(i=>i instanceof HTMLAnchorElement);if(t){e.preventDefault();const i=decodeURIComponent(t.hash?.substring(1)),n=document.getElementById(i);if(n){const o=parseInt(this.dataset.navbarHeight||g.toString()),c=n.getBoundingClientRect().top+window.scrollY-o;window.scrollTo({top:c,behavior:"smooth"})}const s=this.headingIdxMap.get(i);s!==void 0?this.anchorNavTarget=this.headings[s]:this.anchorNavTarget=null,this.dataset.isFloating==="true"&&this.toggleFloatingPanel(!1)}};isPostPage(){return window.location.pathname.includes("/posts/")||document.querySelector(".custom-md, .markdown-content")!==null}updateFloatingPosition=()=>{if(this.dataset.isFloating!=="true")return;const e=this.querySelector(".toc-floating-container"),t=document.getElementById("back-to-top-btn");!e||!t||(t.classList.contains("hide")?e.classList.remove("move-up"):e.classList.add("move-up"))};toggleFloatingPanel(e){const t=this.querySelector(".toc-floating-panel");t&&(e?(t.classList.remove("hidden"),requestAnimationFrame(()=>{t.classList.remove("opacity-0","translate-y-4","pointer-events-none")})):(t.classList.add("opacity-0","translate-y-4","pointer-events-none"),setTimeout(()=>{t.classList.add("hidden")},300)))}regenerateTOC(){const e=this.dataset.isFloating==="true",t=e?this.querySelector(".toc-floating-container"):this.closest("widget-layout");if(!t)return!1;const i=u.getPageHeadings();if(i.length===0&&this.isPostPage()&&this._retryCount<3)return this._retryCount++,setTimeout(()=>this.init(),120),!1;this._retryCount=0;const n=this.isPostPage();if(i.length===0&&!n)return t.classList.contains("toc-hide")||(e?t.classList.add("toc-hide"):(t.style.maxHeight=t.offsetHeight+"px",t.offsetHeight,t.classList.add("toc-hide"),t.style.maxHeight="")),!0;if(t.classList.contains("toc-hide")&&(t.classList.remove("toc-hide"),!e)){const a=t.scrollHeight;t.style.maxHeight="0px",t.offsetHeight,t.style.maxHeight=a+"px",setTimeout(()=>{t.classList.contains("toc-hide")||(t.style.maxHeight="")},300)}const s=Math.min(...i.map(a=>a.depth)),o=parseInt(this.dataset.depth||"3");let c=1;const l=i.filter(a=>a.depth<s+o).map(a=>{const h=a.depth===s?"":a.depth===s+1?"ml-4":"ml-8",d=a.depth===s?c++:a.depth===s+1?'<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>':'<div class="transition w-1.5 h-1.5 rounded-sm bg-black/5 dark:bg-white/10"></div>';return`<a href="#${a.slug}" class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2">
                    <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${h} ${a.depth===s?"bg-[var(--toc-badge-bg)] text-[var(--btn-content)]":""}">
                        ${d}
                    </div>
                    <div class="transition text-sm ${a.depth<=s+1?"text-50":"text-30"}">${a.text}</div>
                </a>`}).join(""),r=this.querySelector(".toc-inner-content");return r&&(r.innerHTML=l+'<div class="active-indicator -z-10 absolute left-0 right-0 rounded-xl transition-all pointer-events-none bg-[var(--toc-btn-hover)]" style="opacity: 0"></div>'),!0}init(){if(this.observer.disconnect(),this.headingIdxMap.clear(),this.headings=[],this.active=[],!this.regenerateTOC())return;if(this.tocEl=this.querySelector(".toc-scroll-container"),this.tocEl?.addEventListener("click",this.handleAnchorClick,{capture:!0}),this.activeIndicator=this.querySelector(".active-indicator"),this.dataset.isFloating==="true"){const n=this.querySelector(".toc-floating-btn");n?.removeEventListener("click",this._handleBtnClick),n?.addEventListener("click",this._handleBtnClick),document.removeEventListener("click",this._handleDocClick),document.addEventListener("click",this._handleDocClick);const s=document.getElementById("back-to-top-btn");s&&(this._backToTopObserver?.disconnect(),this._backToTopObserver=new MutationObserver(o=>{o.forEach(c=>{c.type==="attributes"&&c.attributeName==="class"&&this.updateFloatingPosition()})}),this._backToTopObserver.observe(s,{attributes:!0}),this.updateFloatingPosition())}const e=Array.from(this.querySelectorAll("a[href^='#']")),t=[],i=[];for(let n=0;n<e.length;n++){const s=e[n],o=decodeURIComponent(s.hash?.substring(1)),c=document.getElementById(o);c instanceof HTMLElement&&(t.push(c),i.push(s),this.headingIdxMap.set(o,i.length-1))}this.headings=t,this.tocEntries=i,this.active=new Array(this.tocEntries.length).fill(!1),this.tocEntries.length!==0&&(this.headings.forEach(n=>this.observer.observe(n)),this.fallback(),this.update())}connectedCallback(){const e=document.querySelector(".custom-md")||document.querySelector(".prose")||document.querySelector(".markdown-content");let t=!1;const i=()=>{t||(t=!0,this.init())};e?(e.addEventListener("animationend",i,{once:!0}),setTimeout(i,300)):(i(),setTimeout(i,300));const n=()=>{if(window.swup&&window.swup.hooks){if(this._swupListenersAdded)return;window.swup.hooks.on("visit:start",()=>{if(this.isPostPage()){const s=this.dataset.isFloating==="true",o=s?this.querySelector(".toc-floating-container"):this.closest("widget-layout");o&&!o.classList.contains("toc-hide")&&(s?o.classList.add("toc-hide"):(o.style.maxHeight=o.offsetHeight+"px",o.offsetHeight,o.classList.add("toc-hide"),o.style.maxHeight=""))}}),window.swup.hooks.on("content:replace",()=>{const s=this.dataset.isFloating==="true",o=s?this.querySelector(".toc-floating-container"):this.closest("widget-layout");o&&!this.isPostPage()&&(o.classList.add("toc-hide"),s||(o.style.maxHeight="")),setTimeout(()=>this.init(),100)}),this._swupListenersAdded=!0}};window.swup?n():document.addEventListener("swup:enable",n),window.addEventListener("content-decrypted",()=>this.init())}disconnectedCallback(){this.headings.forEach(t=>this.observer.unobserve(t)),this.observer.disconnect(),this._backToTopObserver?.disconnect(),this.tocEl?.removeEventListener("click",this.handleAnchorClick),this.querySelector(".toc-floating-btn")?.removeEventListener("click",this._handleBtnClick),document.removeEventListener("click",this._handleDocClick)}}customElements.get("table-of-contents")||customElements.define("table-of-contents",f);
