(()=>{const a=window.scrollTo,m=window.scrollBy,r=Element.prototype.scrollIntoView,o={enabled:!1,allowedY:null,startTime:0,duration:0,timeout:null};function u(){const e=new Error().stack;if(e&&(e.includes("handleAnchorClick")||e.includes("TOC.astro"))||window.tocClickTimestamp&&Date.now()-window.tocClickTimestamp<1e3)return!0;const t=document.activeElement;return!!(t&&t.closest("#toc, .table-of-contents"))}function n(e=3e3,t=null){o.enabled=!0,o.allowedY=t!==null?t:window.scrollY||window.pageYOffset,o.startTime=Date.now(),o.duration=e,o.timeout&&clearTimeout(o.timeout),o.timeout=setTimeout(()=>{o.enabled=!1,console.log("[强力滚动保护] 保护期结束")},e),console.log(`[强力滚动保护] 启动保护 ${e}ms，允许Y位置:`,o.allowedY)}function i(e,t){if(!o.enabled)return!0;if(u())return console.log("[强力滚动保护] 检测到TOC导航，允许滚动"),!0;const s=50,c=o.allowedY;return Math.abs(t-c)<=s?!0:t<100&&c>100?(console.log("[强力滚动保护] 阻止滚动到顶部，目标Y:",t,"允许Y:",c),!1):!0}window.scrollTo=(e,t)=>{if(typeof e=="object"){const l=e;e=l.left||0,t=l.top||0}i(e,t)?a.call(window,e,t):(console.log("[强力滚动保护] 阻止 scrollTo:",e,t),a.call(window,e,o.allowedY))},window.scrollBy=(e,t)=>{const s=(window.scrollY||window.pageYOffset)+t;if(typeof e=="object"){const c=e;e=c.left||0,t=c.top||0}i(e,s)?m.call(window,e,t):console.log("[强力滚动保护] 阻止 scrollBy:",e,t)},Element.prototype.scrollIntoView=function(e){if(!o.enabled){r.call(this,e);return}const t=this.getBoundingClientRect(),s=(window.scrollY||window.pageYOffset)+t.top;i(0,s)?r.call(this,e):console.log("[强力滚动保护] 阻止 scrollIntoView")},document.addEventListener("click",e=>{const t=e.target;if(t.closest("#toc, .table-of-contents")&&t.closest('a[href^="#"]')){window.tocClickTimestamp=Date.now(),console.log("[强力滚动保护] 检测到TOC导航点击");return}if((t.closest("#tcomment")||t.matches(".tk-action-icon, .tk-submit, .tk-cancel, .tk-preview, .tk-owo, .tk-admin, .tk-edit, .tk-delete, .tk-reply, .tk-expand")||t.closest(".tk-action-icon, .tk-submit, .tk-cancel, .tk-preview, .tk-owo, .tk-admin, .tk-edit, .tk-delete, .tk-reply, .tk-expand"))&&(n(4e3),console.log("[强力滚动保护] 检测到 Twikoo 交互，启动保护")),(t.matches(".tk-admin-panel, .tk-admin-overlay, .tk-modal, .tk-dialog, .tk-admin-close, .tk-close")||t.closest(".tk-admin-panel, .tk-admin-overlay, .tk-modal, .tk-dialog, .tk-admin-close, .tk-close")||t.classList.contains("tk-admin")||t.closest(".tk-admin"))&&(n(6e3),console.log("[强力滚动保护] 检测到 Twikoo 管理面板操作，启动长期保护")),t.classList.contains("tk-overlay")||t.classList.contains("tk-mask")||t.matches('[class*="overlay"]')||t.matches('[class*="mask"]')||t.matches('[class*="backdrop"]')){const l=document.querySelector("#tcomment");l&&(t.closest("#tcomment")||l.contains(t))&&(n(4e3),console.log("[强力滚动保护] 检测到 Twikoo 遮罩层点击，启动保护"))}},!0),document.addEventListener("submit",e=>{e.target.closest("#tcomment")&&(n(4e3),console.log("[强力滚动保护] 检测到 Twikoo 表单提交，启动保护"))},!0),document.addEventListener("keydown",e=>{if(e.key==="Escape"||e.keyCode===27){const t=document.querySelector("#tcomment");if(t){const l=t.querySelector(".tk-admin-panel, .tk-modal, .tk-dialog, [class*='admin'], [class*='modal']");l&&l.offsetParent!==null&&(n(3e3),console.log("[强力滚动保护] 检测到 ESC 键关闭 Twikoo 管理面板，启动保护"))}}},!0);const d=new MutationObserver(e=>{e.forEach(t=>{if(t.type==="childList"||t.type==="attributes"){const l=t.target;l.closest&&l.closest("#tcomment")&&(t.removedNodes.length>0||t.type==="attributes"&&t.attributeName==="style")&&(n(2e3),console.log("[强力滚动保护] 检测到 Twikoo DOM 变化（可能是面板关闭），启动保护"))}})});document.body?d.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}):document.addEventListener("DOMContentLoaded",()=>{d.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})}),window.scrollProtectionManager={enable:n,disable:()=>{o.enabled=!1,o.timeout&&clearTimeout(o.timeout),console.log("[强力滚动保护] 手动停止保护")},isEnabled:()=>o.enabled,getStatus:()=>({...o}),forceProtect:(e=1e4)=>{n(e),console.log(`[强力滚动保护] 强制保护模式启动 ${e}ms`)},getCurrentScroll:()=>({x:window.scrollX||window.pageXOffset,y:window.scrollY||window.pageYOffset}),checkTwikooStatus:()=>{const e=document.querySelector("#tcomment");if(!e)return{exists:!1};const t=e.querySelectorAll(".tk-admin-panel, .tk-modal, .tk-dialog, [class*='admin'], [class*='modal']"),l=Array.from(t).filter(s=>s.offsetParent!==null);return{exists:!0,adminPanelsCount:t.length,visiblePanelsCount:l.length,hasVisiblePanels:l.length>0}}},console.log("[强力滚动保护] 初始化完成")})();
